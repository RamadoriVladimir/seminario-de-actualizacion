<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Custom Element Example</title>
</head>
<body>
</body>

<script>
	class XRequest extends HTMLElement {
		constructor() {
			super();

			this.btn1 = document.createElement('button');
			this.outputTable = document.createElement('table');
            this.outputTable.border = '1';

			this.btn1.innerText = 'Efectuar peticion';

            this.appendChild(this.btn1);
			this.appendChild(this.outputTable);
		}

		onButton1Click(event) {
            const xhr = new window.XMLHttpRequest();

            xhr.onload = (event) => this.handleResponse(xhr);
            xhr.onerror = (event) => this.handleError(xhr);
            xhr.open('GET', 'https://jsonplaceholder.typicode.com/posts');

            xhr.send();
		}

        handleResponse(xhr) {
             if (xhr.readyState !== 4 && xhr.status !== 200) {
                this.handleError(xhr);
                return;
            } 

            this.outputTable.textContent = '';
            const data = JSON.parse(xhr.responseText);

            const thead = this.createTableHeader(['userId', 'id', 'title', 'body']);
            const tbody = this.createTableBody(data);

            this.outputTable.appendChild(thead);
            this.outputTable.appendChild(tbody);
        }

        handleError(xhr) {
            console.error(xhr.statusText);
        }

        createTableHeader(columns) {
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            columns.forEach ( key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            })

            thead.appendChild(headerRow);
            return thead;
        }
        
        createTableBody(data) {
            const tbody = document.createElement('tbody');
            
            for (let post of data) {
                const tr = document.createElement('tr');

                const userIdTd = this.createCell(post.userId);
                const idTd = this.createCell(post.id);
                const titleTd = this.createCell(post.title);
                const bodyTd = this.createCell(post.body);

                tr.appendChild(userIdTd);
                tr.appendChild(idTd);
                tr.appendChild(titleTd);
                tr.appendChild(bodyTd);

                tbody.appendChild(tr);
            }
            return tbody;
        }

        createCell(value) {
            const td = document.createElement('td');
            td.textContent = value;
            return td;
        }

		connectedCallback() {
			this.btn1.onclick = this.onButton1Click.bind(this);
		}

        disconnectedCallback() {
            this.btn1.onclick = null;
        }
    }

	customElements.define('x-request', XRequest);

	function main() {
        let xrequest = new XRequest();
		document.body.appendChild(xrequest);
	}

	window.onload = main;
</script>
</html>
